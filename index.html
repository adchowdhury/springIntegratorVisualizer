<html>
	<head>
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.13.2/themes/base/jquery-ui.min.css" integrity="sha512-ELV+xyi8IhEApPS/pSj66+Jiw+sOT1Mqkzlh8ExXihe4zfqbWkxPRi8wptXIO9g73FSlhmquFlUOuMSoXz5IRw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.13.2/themes/base/theme.min.css" integrity="sha512-hbs/7O+vqWZS49DulqH1n2lVtu63t3c3MTAn0oYMINS5aT8eIAbJGDXgLt6IxDHcWyzVTgf9XyzZ9iWyVQ7mCQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
		
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.1/jquery.min.js" integrity="sha512-aVKKRRi/Q/YV+4mjoKBsE4x3H+BkegoM/em46NNlCqNTmUYADjBbeNefNxYV7giUp0VxICtqdrbqU7iVaeZNXA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.13.2/jquery-ui.min.js" integrity="sha512-57oZ/vW8ANMjR/KQ6Be9v/+/h6bq9/l3f0Oc7vn6qMqyhvPd1cvKBRWWpzu0QoneImqr2SkmO4MSqU+RpHom3Q==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
		
		<title>Spring Integration Graph</title>
		<style>
		.draggable{
			width: 150px;
			height: 60px;
			cursor: move;
			word-wrap: break-word;
			font-size: 12;
			margin-bottom: 4px;
			position: absolute;
			-webkit-box-shadow: 0px 0px 5px 0px rgba(0,0,0,0.25);
			-moz-box-shadow: 0px 0px 5px 0px rgba(0,0,0,0.25);
			box-shadow: 0px 0px 5px 0px rgba(0,0,0,0.25);	
			padding:3px;
			word-break: break-all;
		}
		.channel{
			border: 1px solid black;
			background: lightcyan;
		}
		.router{
			border: 1px solid green;
			background: lightyellow;
		}
		.gateway{
			border: 1px solid blue;
			background: aliceblue;
		}
		.chain{
			border: 1px solid red;
			background: lightyellow;
		}
		.ui-tooltip{
			font-size: 12;
			height: auto;
			word-wrap: break-word;
			vertical-align: middle;
		}
		#lineContainer{
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
		}
		.output{
			position: absolute;
			left: 153px;
			top:20;
		}
		.input{
			position: absolute;
			left: -5;
			top:20;
		}
		.josnData{
			font-style: italic;
			border: 1px solid black;
			font-size: 11;
			word-wrap: break-word;
			justify-content: space-evenly;
			background: #f7f5f5;
		}
		path:hover {
		  stroke-width:5px;
		  stroke: magenta;
		  
		}
		path{
			cursor: pointer;
		}
		.highlight{
			border: 2px solid aqua !important;
			box-shadow: 0px 0px 5px 0px rgba(0,0,0,0.5);
		}
		.contnet-img{
			float: left;
		    margin-right: 5px;
		    margin-bottom: 3px;
		    border: 2px solid #000;
		    margin-top: 10px;
		}
		.contentblock{
            overflow: hidden;
            max-height: 60px;
        }
		</style>
		<script>
		let jsonData = null;
		
		function loadData(){
			if(!$("#sURL").val()){
				alert("Please provide valid URL to load data from...");
				$("#sURL").focus();
				return;
			}
			$.getJSON($("#sURL").val(), function(data){
				$("#lineContainer").empty();
				$("#mainContainer div").remove();
				currentPosition = {left: 0, top: 0};
	            console.log(data.nodes); 
	            console.log(data.links); 
	            jsonData = data;
	            printGraph();
	            
	            $( ".draggable" ).draggable({
	                obstacle:".butNotHere",
	                preventCollision: true,
	                containment: "#mainContainer",
	                start: function(event, ui) {
	                    $(this).removeClass('butNotHere');
	                },drag: function() {
	                	updateConnectors($(this).attr("id"));
	                },stop: function(event, ui) {
	                    $(this).addClass('butNotHere');
	                    updateConnectors($(this).attr("id"));
	                }
	            });
	            
	            drawConnectors();
	        }).fail(function(excp){
	            console.log("An error has occurred.");
	            console.log(excp);
	            alert("An error has occurred.");
	        });
		}
		
	    $(document).ready(function(){
	    	$("#lineContainer").css({top: $("#mainContainer").css('top'), left: $("#mainContainer").css('left')});
	        $( document ).tooltip({
	            track: true,
	            content: function () {
	                return $(this).prop('title');
	            }
	        });
	        $("#intervalFrequency").prop('selectedIndex', 0);
	    });//document ready
	    
	    let currentPosition = {left: 0, top: 0};
	    
	    function nextPosition(){
	    	currentPosition.left++;
	    	currentPosition.top++;
	    	if(currentPosition.left > 5){
	    		currentPosition.left = 1;
	    	}
	    }
	    
	    function printGraph(){
	    	let inputs = [];
	    	let outputs = [];
	    	
	    	$.each(jsonData.links, function( index, value ) {
	    		inputs.push(value.to);
	    		outputs.push(value.from);
	    	});
	    	let nodeCounter = 1;
	    	$.each(jsonData.nodes, function( index, value ) {
	    		if(inputs.includes(value.nodeId) == false){
	    			if(value.componentType === "null-channel"){
	    				return;
	    			}
	    			currentPosition.left = 0;
	    			currentPosition.top++;
	    			$("#mainContainer").append(getNodeUI(value));
	    			
	    			drawChain(value.nodeId);
	    		}
	    	});
	    	
	    	$.each(jsonData.nodes, function( index, value ) {
    			if(value.componentType === "null-channel"){
    				return;
    			}
    			if($("#node_" + value.nodeId).length > 0){
    				return;
    			}

    			currentPosition.left = 0;
    			currentPosition.top++;
    			$("#mainContainer").append(getNodeUI(value));
    			drawChain(value.nodeId);
	    	});
	    	
	    	$("#mainContainer").height(currentPosition.top * 45);
	    	
	    	$("#lineContainer").height($("#mainContainer").height());
	    	$("#lineContainer").css({top: $("#mainContainer").css('top'), left: $("#mainContainer").css('left')});
	    	
	    	$(".output").hide();
	    	$(".input").hide();
	    }
	    
	    function getNodeByID(a_nodeID){
	    	let returnNode = null;
	    	$.each(jsonData.nodes, function( index, value ) {
	    		if(value.nodeId == a_nodeID){
	    			returnNode = value;
	    		}
	    	});
	    	return returnNode;
	    }
	    
	    function drawChain(a_outputNodeId){
	    	$.each(jsonData.links, function( index, value ) {
	    		//console.log(value.from + " - " + a_outputNodeId);
	    		if(value.from == a_outputNodeId){
	    			if($("#node_" + value.to).length < 1){
		    			$("#mainContainer").append(getNodeUI(getNodeByID(value.to)));
		    			drawChain(value.to);
	    			}
	    		}
	    	});
	    }
	    
	    function getNodeUI(a_object){
	    	let nodeType = a_object.componentType;
	    	if(a_object.componentType === "ws:inbound-gateway" || a_object.componentType === "service-activator"
	    		 || a_object.componentType === "nullChannel"){
		    	nodeType = "gateway";
	    		
	    	}
	    	
	    	let leftPos = (currentPosition.left * 250) + 50;
	    	let topPos = (currentPosition.top * 40) + 50;
	    	
	    	nextPosition();
	    	let tooltipText = '<b style="color:red">'+(a_object.nodeId + '# ('+a_object.componentType+')</b></br>' + a_object.name)+'<br/><p class="josnData">' + JSON.stringify(a_object)  + '</p>';
	    	let returnString = "<div class='"+nodeType+" butNotHere draggable' title='"+tooltipText+"' id='node_" + a_object.nodeId 
	    	+ "' style='left:"+leftPos +"; top: "+topPos+"'><div class='contentblock'>";
	    	
	    	if(a_object.componentType === "router"){
	    		returnString += "<img src='router.png' class='contnet-img' width='30px'/>";
	    	}else if(a_object.componentType === "service-activator"){
	    		returnString += "<img src='serviceActivator.jpg' class='contnet-img' width='30px'/>";
	    	}else if(a_object.componentType === "gateway" || a_object.componentType === "ws:inbound-gateway"){
	    		returnString += "<img src='gateway.jpg' class='contnet-img' width='30px'/>";
	    	}else if(a_object.componentType === "chain"){
	    		returnString += "<img src='chain.png' class='contnet-img' width='30px'/>";
	    	}else if(a_object.componentType === "channel"){
	    		returnString += "<img src='channel.png' class='contnet-img' width='30px'/>";
	    	}
	    	returnString += "<span>" + a_object.name + "</span></div>";
	    	returnString += "<span class='output'>&#9654;</span>";
	    	returnString += "<span class='input'>&#9654;</span>";
	    	
	    	returnString += "</div>";
	    	return returnString;
	    }
	    
	    function drawConnectors(){
	    	let connectorColour = "blue";
	    	let strokedasharray = "5,10,5";
	    	
	    	$.each(jsonData.links, function( index, value ) {
	    		value.ID=index;
	    		//console.log(value.from + "->" + value.to);
	    		if($("#node_" + value.from).length > 0 && $("#node_" + value.to).length > 0){
	    			
	    			if($("#node_" + value.from).hasClass("channel") && $("#node_" + value.to).hasClass("router")){
	    				connectorColour = "green";
	    			}else if($("#node_" + value.from).hasClass("channel") && $("#node_" + value.to).hasClass("chain")){
	    				connectorColour = "purple";
	    			}else{
	    				connectorColour = "blue";
	    			}
	    		    
	    		    let newLine = $(document.createElementNS('http://www.w3.org/2000/svg','path')).attr({
	    		          id:'path_' + index,
	    		          'stroke-width':'3px',
	    		          stroke:connectorColour,
	    		          fill:"none",
	    		          'stroke-linecap':"round"
	    		    });
	    		    
	    		    
	    			$("#lineContainer").append(newLine);
	    			if(value.type === 'route'){
	    				$(newLine).attr('stroke-dasharray', "10,10,10");
	    			}else if(value.type === 'input'){
	    				$(newLine).attr('stroke-dasharray', "5,5,5");
	    			}
	    			
	    			if(value.type === 'error'){
	    				$(newLine).attr('stroke', "red");
	    			}
	    			updateLinePath(value);
	    		}
	    	});	  
	    	
	    	$( "path" )
	    	  .mouseenter(function() {
	    	    console.log($(this ).attr("id"));
	    	    let currentLink = getLinkByID($(this ).attr("id"));
	    	    $("#node_" + currentLink.from).toggleClass("highlight");
	    	    $("#node_" + currentLink.to).toggleClass("highlight");
	    	    //highlight
	    	  })
	    	  .mouseleave(function() {
	    		console.log($(this ).attr("id"));
	    	    let currentLink = getLinkByID($(this ).attr("id"));
	    	    $("#node_" + currentLink.from).toggleClass("highlight");
	    	    $("#node_" + currentLink.to).toggleClass("highlight");
	    	  });
	    }
	    
	    function getLinkByID(a_linkID){
	    	let srcID = parseInt(a_linkID.substring(5));
	    	let returnLink = null;
	    	$.each(jsonData.links, function( index, value ) {
	    		if(value.ID == srcID){
	    			returnLink = value;
	    		}
	    	});
	    	return returnLink;
	    }
	    
	    
	    function updateConnectors(a_sourceId){
	    	let src = parseInt(a_sourceId.substring(5));
	    	
	    	let filteredLines = jsonData.links.filter(function(obj) {
	    		if(obj.from == src){
	    			//console.log(obj.from);
	    			return obj;
	    		}
	    		
	    	});
	    	
	    	$.each(filteredLines, function( index, value ) {
	    		if($("#path_" + value.ID).length > 0){
	    			updateLinePath(value);
	    		}
	    		//console.log($("#path_" + value.ID	))
	    	});
	    	
	    	 filteredLines = jsonData.links.filter(function(obj) {
	    		if(obj.to == src){
	    			//console.log(obj.from);
	    			return obj;
	    		}
	    		
	    	});
	    	 
	    	 $.each(filteredLines, function( index, value ) {
	    		if($("#path_" + value.ID).length > 0){
	    			updateLinePath(value);
	    		}
	    		//console.log($("#path_" + value.ID	))
	    	});
	    	//console.log(src);
	    }
	    
	    function updateLinePath(a_link){
	    	let startPos = $("#node_" + a_link.from).position();
    		startPos.left += 145;
    		startPos.top = startPos.top - 51;
    		
    		let endPos = $("#node_" + a_link.to).position();
    		endPos.left -= 10;
    		endPos.top = endPos.top - 51;;
    		
    		let midX = startPos.left + 20;
    		let midY = startPos.top;
    		
    		let midX1 = midX;
    		let midY1 = endPos.top;
    		
    		//let direction = "M" + Math.ceil(startPos.left) + "," + Math.ceil(startPos.top) + " Q" + Math.ceil(midX) + "," + Math.ceil(midY) + " " + Math.ceil(endPos.left) + "," + Math.ceil(endPos.top) + " ";
    		//let direction = "M" + Math.ceil(startPos.left) + "," + Math.ceil(startPos.top) + " Q" + midX + "," + midY + " " + midX1 + "," + midY1 + " T" + endPos.left + "," + Math.ceil(endPos.top);
    		
    		let direction = "M" + (startPos.left) + "," + (startPos.top) + " L" + midX + "," + midY + " L" + midX1 + "," + midY1 + " L" + endPos.left + "," + (endPos.top);
    		
    		if(startPos.left > endPos.left){
    			
    			midY1 = endPos.top + 15;
        		
        		let midX2 = endPos.left - 15;
        		let midY2 = endPos.top + 15;
        		
        		let midX3 = midX2;
        		let midY3 = endPos.top;
        		
        		direction = "M" + (startPos.left) + "," + (startPos.top) + " L" + midX + "," + midY + " L" + midX1 + "," + midY1 + " L" + midX2 + "," + midY2 + " L" + midX3 + "," + midY3 + " L" + endPos.left + "," + (endPos.top);
    			
    		}
    		
    		$("#path_" + a_link.ID).attr("d", direction);
    		
    		$("#node_" + a_link.from).find(".output").show();
    		$("#node_" + a_link.to).find(".input").show();
    		//console.log(direction)
	    }
	    
	    function getRandomInt(min, max) {
    	  min = Math.ceil(min);
    	  max = Math.floor(max);
    	  return Math.floor(Math.random() * (max - min) + min); // The maximum is exclusive and the minimum is inclusive
    	}

	    
	    let intervalElement;
	    
	    function reloadInterval(){
	    	let frequency = $('#intervalFrequency').find(":selected").val();
	    	if(intervalElement){
		    	clearInterval(intervalElement);
	    	}
	    	
	    	if(frequency < 0){
	    		clearInterval(intervalElement);
	    	}else{
	    		intervalElement = setInterval(loadData, 1000 * frequency);
	    	}
	    }
	    
    </script> 
	</head>
	<body>
		<div style="background: #dce6df; height: 50; padding-top: 20;">
			Server URL: <input size="100" type="text" id="sURL" name="sURL" value="https://apps.trigyn.com/hrsSIT/view/springJSONData"/> <button onclick="loadData()">Load Data</button>
			Reload interval : 
			<select id="intervalFrequency" name="intervalFrequency" onchange="reloadInterval()">
				<option value="-1" selected="selected">None</option>
				<option value="30">30 Secs</option>
				<option value="60">60 Secs</option>
			</select>
		</div>
		<div id="mainContainer" class="ui-widget ui-widget-content">
			<svg id="lineContainer">
			</svg>
		</div>
	</body>
</html>